import React, { useState, useRef, useEffect } from 'react';
import { Brain, Eraser } from 'lucide-react';

export default function DigitRecognition() {
    const canvasRef = useRef(null);
    const [isDrawing, setIsDrawing] = useState(false);
    const [predictions, setPredictions] = useState([]);
    const [isProcessing, setIsProcessing] = useState(false);

    useEffect(() => {
        const canvas = canvasRef.current;
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
    }, []);

    const startDrawing = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const ctx = canvas.getContext('2d');

        setIsDrawing(true);
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    };

    const draw = (e) => {
        if (!isDrawing) return;

        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const ctx = canvas.getContext('2d');

        ctx.strokeStyle = 'white';
        ctx.lineWidth = 20;
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    };

    const stopDrawing = () => {
        if (isDrawing) {
            setIsDrawing(false);
            recognizeDigit();
        }
    };

    const recognizeDigit = async () => {
        setIsProcessing(true);

        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        // Get image data and convert to 28x28 grayscale
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        // Convert to grayscale and normalize
        const grayscale = [];
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            grayscale.push(avg / 255);
        }

        // Simulate neural network predictions with realistic probabilities
        // In a real implementation, this would call your trained model
        await new Promise(resolve => setTimeout(resolve, 300));

        // Generate pseudo-random but realistic predictions
        const randomDigit = Math.floor(Math.random() * 10);
        const preds = Array.from({ length: 10 }, (_, i) => {
            if (i === randomDigit) {
                return { digit: i, confidence: 0.75 + Math.random() * 0.24 };
            } else {
                return { digit: i, confidence: Math.random() * 0.15 };
            }
        }).sort((a, b) => b.confidence - a.confidence);

        setPredictions(preds);
        setIsProcessing(false);
    };

    const clearCanvas = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        setPredictions([]);
    };

    const getBarColor = (index) => {
        const colors = [
            'bg-blue-500',
            'bg-green-500',
            'bg-yellow-500',
            'bg-orange-500',
            'bg-red-500',
            'bg-purple-500',
            'bg-pink-500',
            'bg-indigo-500',
            'bg-teal-500',
            'bg-cyan-500'
        ];
        return colors[index % colors.length];
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8">
            <div className="max-w-6xl mx-auto">
                <div className="text-center mb-8">
                    <h1 className="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
                        <Brain className="w-10 h-10" />
                        Digit Recognition
                    </h1>
                    <p className="text-gray-300">Draw a digit (0-9) and watch the AI recognize it</p>
                </div>

                <div className="grid md:grid-cols-2 gap-8">
                    {/* Drawing Canvas */}
                    <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl">

                        <div className="mb-4">
                            <h2 className="text-xl font-semibold text-white mb-2">Draw Here</h2>
                            <p className="text-gray-300 text-sm">Use your mouse to draw a digit</p>
                        </div>

                        {predictions.length > 0 && (
                            <div className="mt-6 p-4 bg-green-500/20 border border-green-500/50 rounded-lg">
                                <div className="text-center">
                                    <p className="text-gray-300 text-sm mb-1">Best Match</p>
                                    <p className="text-6xl font-bold text-white">{predictions[0].digit}</p>
                                    <p className="text-green-400 text-lg font-semibold mt-2">
                                        {(predictions[0].confidence * 100).toFixed(1)}% confidence
                                    </p>
                                </div>
                            </div>
                        )}


                        <div className="relative">
                            <canvas
                                ref={canvasRef}
                                width={400}
                                height={400}
                                className="border-4 border-white/20 rounded-xl cursor-crosshair w-full"
                                onMouseDown={startDrawing}
                                onMouseMove={draw}
                                onMouseUp={stopDrawing}
                                onMouseLeave={stopDrawing}
                            />
                            {isProcessing && (
                                <div className="absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center">
                                    <div className="text-white text-lg font-semibold">Recognizing...</div>
                                </div>
                            )}
                        </div>

                        <button
                            onClick={clearCanvas}
                            className="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                        >
                            <Eraser className="w-5 h-5" />
                            Clear Canvas
                        </button>
                    </div>

                </div>

                <div className="mt-8 text-center text-gray-400 text-sm">
                    <p>ðŸ’¡ Note: This is a demo with simulated predictions. Connect a real ML model for actual digit recognition!</p>
                </div>
            </div>
        </div>
    );
}